# 搭建前端基本开发环境
## IDE选择
确定好使用哪个开发IDE，此项目使用 VSCODE

## 插件选择
确定好需要哪些对应的插件，此项目需要的插件有

1. minapp
2. 


## 确定好代码规范
确定好项目的代码风格和规范是非常重要的一件事情，此项目遵循以下规范

根目录下有：

```bash
- .gitignore       // 忽略文件
- .prettierrc      // 配置格式化
- .editorconfig    // 配置编辑器风格
- .babelrc         // 转译器配置
- .eslintrc        // eslint配置 
- .eslintignore    // eslint忽略配置  
```

1. 统一使用es6+
2. 不使用分号结尾
3. 使用eslint-stanard规则

# 完成构建工程

## 构建工具选择
确定好项目的构建工具是非常重要的一件事，如果没有好的构建脚本，就需要自己亲自写一个构建脚本，要有这种自己编写构建工具的能力。此项目使用gulp作为构建工具，原因如下

1. 小程序涉及到项目资源分类管理，使用gulp很合适
2. 使用gulp的task，可以对不同的文件类型、文件夹、文件等进行不同的处理流程，非常方便管理
3. 小程序本身就必须在开发者工具的runtime中才能跑起来，不涉及到服务搭建，所以webpack的devserver也没有用武之地。确切来说，webpack的产品定位是模块打包工具，而小程序涉及到资源分类管理。

## 确定项目目录
```
- cloud-functions // 云函数文件夹
- dist            // 构建工具输出之后的文件夹
- gulpfile.js     // gulp配置文件
- node_modules    
- package.json    // npm描述文件
- src             // 开发的源代码文件
  - app.js        // 小程序入口js
  - app.json      // 小程序配置
  - app.scss      // 小程序整体样式
  - components    // 小程序组件
  - images        // 小程序静态图片
  - lib           // 公共lib
  - pages         // 小程序page页面
    - index.js
    - index.json
    - index.scss
    - index.wxml
    - index.wxs
- project.config.json  // 小程序项目配置
```
## 根据目录进行gulp工程化
gulp是以task为核心的打包工具，按照我的步骤来，包过。
## 第一步
将src目录下的文件，编译到小程序开发者工具实际运行的dist目录下，在gulpfile.js中定义这两个目录的变量
```js
const src = './src'
const dist = './dist'
```
### 第二步 完成wxml task
直接使用task release到目标目录即可
```js
gulp.task('wxml', () => {
    return gulp
      .src(`${src}/**/*.wxml`)
      .pipe(gulp.dest(dist))
})
```
### 第三把 完成 wxss task
使用sass作为wxss的开发语言，这就需要使用gulp将scss/sass文件编译成wxss，同时在处理样式文件时，解决两个问题

1. px转rpx： 使用postcss-px2rpx
2. 将webfont转换成base64，小程序不允许webfont访问小程序内部地址。

```js
const rename = require('gulp-rename')
const postcss = require('gulp-postcss')
const pxtorpx = require('postcss-px2rpx')
const base64 = require('gulp-font-base64')
const combiner = require('stream-combiner2')

gulp.task('wxss', () => {
    const combined = combiner.obj([
        gulp.src('${src}/**/*.{wxss, scss}'),
        sass().on('error', sass.logError),
        postcss([pxtorpx(), base64()]),
        rename((path) => (path.name = '.wxss')),
        gulp.dest(dist)
    ])

    combined.on('error', handleError)
})
```
注意可以不使用autoprefixer，直接在小程序开发者工具中选中上传代码时样式自动补全。


### 第三步 完成 js task
微信的js文件使用的是ES5语法(为什么？)，这里我在开发中使用了ES6+，所以要在gulp中进行设置，在gulp编译时，引入babel插件，来对JS进行编译，同时引入了sourcemap来方便本地debug代码

```js
gulp.task('js', () => {
    gulp
      .src(`${src}/**/*.js`)
      .pipe(sourcemaps.init())
      .pipe(
          babel({
              presets: ['env']
          })
      )
      .pipe(sourcemaps.write('./'))
      .pipe(gulp.dest(dist))
})
```

### 第四步 完成json images wxs 等task
直接复制到目标目录即可

```js
gulp.task('json', () => {
    return gulp.src(`${src}/**/*.json`).pipe(gulp.dest(dist))
})

gulp.task('iamges', () => {
    return gulp.src(`${src}/images/**`).pipe(gulp.dest(`${dist}/images`))
})

gulp.task('wxs', () => {
    return gulp.src(`${src}/**/*.wxs`).pipe(gulp.dest(dist))
})
```

### 第五步 给每个task增加生产发布打包配置
针对开发和生产两种不同的发布环境，可以通过自定义gulp命令参数来进行区分，这里使用 `--type`来区分，即：

1. `--type prod` 代表生产发布打包
2. 默认是开发发布打包

为什么要这样呢？因为在生产发布打包的流程中，增加了对资源的压缩等功能

```js
const sourcemaps = require('sourcemaps')
const through = require('through2')
const babel = require('gulp-bable')
const uglify = require('gulp-uglify')
const argv = require('minimist')(process.argv.slice(2))

const isProd = argv.type === 'prod'
const src = './client'
const dist = './dist'

gulp.task('js', () => {
    gulp
      .src(`${src}/**/*.js`)
      .pipe(isProd ? through.obj() : sourcemaps.init()) // 如果是prod环境，则不生成sourcemap
      .pipe(
          babel({
              presets: ['env']
          })
      )
      // prod 就压缩
      .pipe(
          isProd ? uglify({
              compress: true
          }) : through.obj()
      )
      .pipe(isProd ? through.obj() : sourcemaps.write('./')) // 如果是prod环境，则不生成sourcemap
      .pipe(gulp.dest(dist))
      
})
```

### 第六步 根据发布环境不同，对task进行聚合
为什么要聚合呢？因为要对某些task进行统一处理
```js
gulp.task('watch', () => {
    ;['wxml', 'wxss', 'js', 'wxs', 'json'].forEach( v => {
        gulp.watch(`${src}/**/*.${v}`, [v])
    })
    gulp.watch(`${src}/images/**`, [images])
    gulp.watch(`${src}/**/*.scss`, ['wxss'])
})

gulp.task('clean', () => {
    return del(['./dist/**'])
})

gulp.task('dev', ['clean'], () => {
    runSequence('json', 'images', 'wxml', 'js', 'wxs', 'cloud', 'watch')
})

gulp.task('build', ['clean'], () => {
    runSequence('json', 'images', 'wxml', 'js', 'wxs', 'cloud')
})
```